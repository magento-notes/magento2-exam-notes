4 - Working with Databases in Magento
=====================================

4.1 Demonstrate ability to use data-related classes
---------------------------------------------------

> Repositories can be applied for working with Collections in Magento 2. It realises the Repository pattern that allows it to work with collections and entities regardless of their storage place (storing or caching are the implementation of details).
>
> A Repository should be stateless after instantiation. This means that every method call should not rely on previous calls nor should it affect later method calls. Any field contained in the repository class must also be stateless.

![Magento Exam Question](./images/icon-question.png)**What mechanisms are available to extend existing classes, for example by adding a new attribute, a new field in the database, or a new related entity?**

*   Custom EAV-Attributes - More info below
*   Extension Attributes - More info below
*   Declarative Schema - More info below
*   Declarative Data - More info below
*   Schema Patches - More info below
*   Data Patches - More info below
*   Custom Repositories and API Classes - More info below

![Magento Exam Question](./images/icon-question.png)**Describe Repositories and data API classes.**

> Repositories give service requesters the ability to perform create, read, update, and delete (CRUD) operations on entities or a list of entities. A repository is an example of a [service contract](https://devdocs.magento.com/guides/v2.2/extension-dev-guide/service-contracts/design-patterns.html&sa=D&ust=1609223264777000&usg=AOvVaw1W0IBLhVtdLevoBCn-pXDX), and its implementation is part of the [domain layer](https://devdocs.magento.com/guides/v2.3/architecture/archi_perspectives/domain_layer.html&sa=D&ust=1609223264778000&usg=AOvVaw36Pi0TnWV7_9eOsx8vcB9l).
>
> Repositories open your entity for the Magento 2 REST API (also requires data model interfaces).
>
> Repositories usually lie within the `<module_dir>/Api/` & `<module_dir>/Api/Data/` Directories.

![Magento Exam Question](./images/icon-question.png)**How do you obtain an object or set of objects from the database using a repository?**

In Magento 2, five basic repository functions are realized using Resource Models. They are

*   `save($entity)`
*   `getById($id)`
*   `getList(SearchCriteria $searchCriteria)`
*   `delete($entity)`
*   `deleteById($id)`

![Magento Exam Note Warning](images/icon-warning.png)You used to be able to save using model->save() - but this is now deprecated, your Resource Model is the place to work with data storage.

![Magento Exam Question](./images/icon-question.png)**How do you configure and create a SearchCriteria instance using the builder? Describe how to filter, sort, and specify the selected values for collections and repositories.**

A Search Criteria is an implementation of the [SearchCriteriaInterface class](https://github.com/magento/magento2/blob/2.2/lib/internal/Magento/Framework/Api/SearchCriteriaInterface.php&sa=D&ust=1609223264781000&usg=AOvVaw2grCpVdTjMrz79L1pEePCH) that allows you to build custom requests with different conditions. Repositories use this class to retrieve entities based on a matching criteria.

![Magento Section Chevron](./images/icon-chevron.png) Filter

> The Filter class is the smallest part of a Search Criteria. It allows you to add a custom field, value, and condition type to the criteria. Example of how to define a Filter:

```php
$filter
   ->setField("url")
   ->setValue("%magento.com")
   ->setConditionType("like");
```

![Magento Section Chevron](./images/icon-chevron.png)Filter Group

> A collection of Filters that apply one or more criteria to a search. Example:

```php
$filter1
   ->setField("url")
   ->setValue("%magento.com")
   ->setConditionType("like");

$filter2
   ->setField("store_id")
   ->setValue("1")
   ->setConditionType("eq");

$filterGroup1->setFilters([$filter1, $filter2]);

$filter3
   ->setField("url_type")
   ->setValue(1)
   ->setConditionType("eq");

$filterGroup2->setFilters([$filter3]);

$searchCriteria->setFilterGroups([$filterGroup1, $filterGroup2]);
```

![Magento Section Chevron](./images/icon-chevron.png)Sorting

> The example below defines a Sort Order object that will sort the customer email in ascending order:

```php
$sortOrder
   ->setField("email")
   ->setDirection("ASC");

$searchCriteria->setSortOrders([$sortOrder]);
```

![Magento Section Chevron](./images/icon-chevron.png)Pagination

> The setPageSize function paginates the Search Criteria by limiting the amount of entities it retrieves:

```php
$searchCriteria->setPageSize(20); //retrieve 20 or less entities
```

![Magento Section Chevron](./images/icon-chevron.png)Search Result

> The getList(SearchCriteria $searchCriteria) method defined in your repository should return a Search Result object. This object is an instance of a class that implements the interface [SearchResultsInterface](https://github.com/magento/magento2/blob/2.2/lib/internal/Magento/Framework/Api/SearchResultsInterface.php&sa=D&ust=1609223264787000&usg=AOvVaw0IMC3MEGEPbw8kXlNd6Y6N).

![Magento Exam Question](./images/icon-question.png)**How do you use Data/Api classes?**

> Api in Magento 2 is commonly used to describe Repository interfaces, further implemented by  Models and Data Models. Repository API interfaces can be applied for WebAPI requests (when they are described in `webapi.xml`). Api directory is located in modules roots, similarly to etc, Model and other directories.
>
> Unlike Api, `Api/Data` directory contains interfaces for the data, for example, store data or customer data.
>
> An excellent example for explaining the difference between Api and `Api/Data` is the implementation of `Magento\Catalog\Api\ProductRepositoryInterface` and `Magento\Catalog\Api\Data\ProductInterface`.
>
> ProductRepository implements a get method that loads a Product object (using ProductFactory) that implements ProductInterface for working with data.

![Magento Exam Information](./images/icon-info.png)Just remember: API Interfaces where Service Contract / Repositories are kept which keep in mind WebAPI - Concerned only with how to retrieve information of a specific entity/model. `Magento\Catalog\Api\ProductRepositoryInterface` for example has methods `get()` and `save()` . API/Data on the other hand are a set of interfaces specifically for the data (which will be implemented by a Model class). `Magento\Catalog\Api\Data\ProductInterface` has model related methods like `getSku()`

![Magento Exam Question](./images/icon-question.png)**Describe how to create and register new entities.**

In Magento 2, entities are unique objects that contain a number of various attributes and/or parameters. Products, Orders & Customers for example. Entities are subsets of [Entity-Attribute-Values (EAV).](https://blog.magestore.com/entity-attribute-value-in-magento/&sa=D&ust=1609223264790000&usg=AOvVaw0Haxczn-QByjK23DXB7e6l)

![Magento Exam Information](./images/icon-info.png)Think EAV, think catalog_product_entity ➞ eav_attribute table ➞ (`catalog_product_entity_varchar`, `catalog_product_decimal`) etc

### ![Magento Section Chevron](./images/icon-chevron.png)Step 1 - Create A Model

Create a new [Module](#h.8r6t4fakpxnh) with [registration](#h.i0qq8aqgijv7), entities can only be created within a module.

The Model usually lies within the `<module_dir>/Model` directory and is the sole entity class. Models are where your main business logic should be handled and is a single instance of an object. The Model will use the Resource Model to talk to the database and get/set data for The Resource Model to `save()` and `load()` / `get()`. Models will extend the class `Magento\Framework\Model\AbstractExtensibleModel`.

Example Model Concrete Class:
```php
<?php

namespace Vendor\MyModule\Model;
class ExampleModel extends Magento\Framework\Model\AbstractExtensibleModel implements Vendor\MyModule\Api\Data\ExampleModelInterface
{
   /** {@inheritdoc} */
   protected function _construct()
   {
       $this->_init(ResourceModel\ExampleResourceModel::class);
   }

   /** {@inheritdoc} */
   public function getId(): int
   {
       return (int) $this->getData(ExampleModelInterface::ENTITY_COLUMN_TABLE_ID);
   }

   /** {@inheritdoc} */
   public function getEntityId(): int
   {
       return $this->getId();
   }

   /** {@inheritdoc} */
   public function getResource(): AbstractDb
   {
       return $this->_getResource();
   }
}
```
### ![Magento Section Chevron](./images/icon-chevron.png)Step 2 - Create Resource Model

> Map an object to one or more database rows. A Resource Model is responsible for performing functions such as:

*   Executing all CRUD (create, read, update, delete) requests. The resource model contains the SQL code for completing these requests.
*   Performing additional business logic. For example, a resource model could perform data validation, start processes before or after data is saved, or perform other database operations.

> Resource models usually lie in the `<module_dir>/Model/ResourceModel` directory. It extends the `Magento\Framework\Model\ResourceModel\Db\AbstractDb` class which handles most C.R.U.D methods. You just need to specify the "table" and "entity_id" within the Magento `_construct()` method:
```php
<?php
namespace Vendor\MyModule\Model\ResourceModel;
class ExampleResourceModel extends Magento\Framework\Model\ResourceModel\Db\AbstractDb
{
        protected function _construct()
        {
                $this->_init('my_table', 'entity_id');
        }
}
```
![Magento Exam Information](./images/icon-info.png)Resource Models and Repositories are very alike, but Resource Model represents a lower level persistence mechanism that should be used by Repositories. It is the only recommended persistence mechanism by Magento right now. Repositories are more concerned with creating access to your custom entity via the REST API.

![Magento Exam Information](./images/icon-info.png)Magento uses an [active record pattern strategy for persistence](https://devdocs.magento.com/guides/v2.3/architecture/archi_perspectives/persist_layer.html&sa=D&ust=1609223264794000&usg=AOvVaw3iHooG-vMX_8WIs2944qx3). Resource Models are an important part of this pattern. Just Remember CRUD here.

### ![Magento Section Chevron](./images/icon-chevron.png)Step 3 - Create Collection

> Collections encapsulate sets of models and related functionality, such as filtering, sorting, and pagination. Collections usually reside in `<module_dir>\Model\ResourceModel\ExampleModel\Collection`
>
> The collection extends `Magento\Framework\Model\ResourceModel\Db\Collection\AbstractCollection` - which provide
>
> you MySQL-like commands as methods, Popular examples methods are:

*   `getConnection()`
*   `getSelect()`
*   `setPageSize()`
*   `addAttributeToSelect()`
*   `getMainTable()`
*   `addFieldToSelect()`
*   `addFieldToFilter()`
*   `join()`

> Collections are great if you're working with entities that have a lot of attributes, filters, or possibly a future large dataset, a good practice for debugging would be to use SQL logging to record actual SQL queries hitting the database.
>
> Example Collection:
```php
<?php
namespace Vendor\MyModule\Model\ResourceModel\ExampleModel;
class Collection extends Magento\Framework\Model\ResourceModel\Db\Collection\AbstractCollection
{
        protected function _construct()
        {
                $this->_init(Vendor\MyModule\Model\ExampleModel, Vendor\MyModule\Model\ResourceModel\ExampleModel);
        }
}
```
![Magento Exam Information](./images/icon-info.png)Remember that Collections are a good use for filtering, sorting, and pagination. They are not 100% necessary when creating new entities but are recommended for scalability.

![Magento Exam Information](./images/icon-info.png)Collections can help us spot possible performance bottlenecks and react on time, either by adding more limiting values to setPageSize or addAttributeToSelect, or both.

### ![Magento Section Chevron](./images/icon-chevron.png)Step 4 - Schema / Data Installation & Upgrade

> Declarative setup
>
> Declarative setup is based on database structure declarations. Schema files declare what the database structure should be, and Magento determines the differences between the current table structure and what it should be. These differences can be represented with atomic SQL operations.
>
> Declarative Schema is defined in [<module_dir>/etc/db_schema.xml](https://devdocs.magento.com/guides/v2.3/extension-dev-guide/declarative-schema/db-schema.html&sa=D&ust=1609223264799000&usg=AOvVaw3DX2NFuBBuc4PtRaiH0XE-)
>
> More on Declarative Setup in [Section 4.2](#h.8i0etxv2dw9i)

### ![Magento Section Chevron](./images/icon-chevron.png)Step 5 - Create A Repository

> Repositories adhere to Magento 2 Service Contracts defined by data interfaces (but extensible by third-party modules). Repositories are a form of Service Contract keep in mind the WebAPI and is located in the <module_dir>/Api & <module_dir>/Api/Data directories then implemented in <module_dir>/Model & <module_dir>/Model/Data. Create a Interfaces in:

*   `<module_dir>/Api/ExampleRepositoryInterface` - containing all the necessary Resource Model CRUD operations.
*   `<module_dir>/Api/Data/ExampleModelInterface` - containing all the necessary getter / setter methods for your Data model.
*   `<module_dir>/Api/DataExampleModelSearchResultInterface` - which extends the `Magento\Framework\Api\SearchResultsInterface` where you can add specific search.

Implementing your Repository as a concrete class:
```php
<?php

namespace Vendor\MyModule\Model;

class ExampleRepository implements Vendor\MyModule\Api\ExampleRepositoryInterface
{
    public function __construct(
        MY\MODULE\Api\Data\ExampleModelFactory $exampleFactory,
        MY\MODULE\Model\ResourceModel\ExampleModel\CollectionFactory $exampleCollectionFactory,
        MY\MODULE\Api\DataExampleModelSearchResultInterfaceFactory $exampleSearchResultInterfaceFactory,
        Magento\Framework\Api\SearchCriteria\CollectionProcessorInterface $collectionProcessor
    ) {
        $this->exampleFactory = $exampleFactory;
        $this->exampleCollectionFactory = $exampleCollectionFactory;
        $this->searchResultFactory = $exampleSearchResultInterfaceFactory;
        $this->collectionProcessor = $collectionProcessor;
    }
    public function getById($id)
    {
        $example = $this->exampleFactory->create();
        $example->getResource()->load($example, $id);
        if (!$example->getId()) {
            throw new NoSuchEntityException(__('Unable to find example with ID "%1"', $id));
        }
        return $example;
    }
    public function save(MY\MODULE\Api\Data\ExampleModelInterface $example)
    {
        $example->getResource()->save($example);
        return $example;
    }
    public function delete(MY\MODULE\Api\Data\ExampleModelInterface $example)
    {
        $example->getResource()->delete($example);
    }
    public function getList(Magento\Framework\Api\SearchCriteriaInterface $searchCriteria)
    {
        $collection = $this->collectionFactory->create();
        $this->collectionProcessor->process($searchCriteria, $collection);
        $searchResults = $this->searchResultFactory->create();
        $searchResults->setSearchCriteria($searchCriteria);
        $searchResults->setItems($collection->getItems());
        return $searchResults;
    }
}

```
![Magento Exam Information](./images/icon-info.png)For smaller operations like getById() & save() The repository will obtain the Resource Model directly to carry out database operations.

![Magento Exam Information](./images/icon-info.png)As good practice, More complex methods such as getList() in the Repository will talk to the Collection which will use the Resource Model to filter and retrieve data from the database more efficiently.

![Magento Exam Information](./images/icon-info.png)Factory classes are used when creating new instantiations of the Model, more on this in the next subsection.

> We must tell Magento 2 to implement these interfaces by setting a preference in the your modules `di.xml`
```xml
<?xml version="1.0"?>
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">
    <preference for="<MY>\<MODULE>\Api\ExampleRepositoryInterface" type=" <MY>\<MODULE>\Model\ExampleRepository" />
    <preference for="<MY>\<MODULE>\Api\Data\ExampleModelInterface" type=" <MY>\<MODULE>\Model\Example" />
    <preference for="<MY>\<MODULE>\Api\Data\ExampleSearchResultInterface" type="Magento\Framework\Api\SearchResults" />
</config>
```

![Magento Exam Information](./images/icon-info.png)Magento requires this definition so that when you inject Interfaces as dependencies it knows which class implementation to load. Very useful for future extension.

![Magento Exam Information](./images/icon-info.png)Usually `Magento\Framework\Api\SearchResults` is nearly always a good enough implementation of `<MY>\<MODULE>\Api\Data\ExampleSearchResultInterface`.

### ![Magento Section Chevron](./images/icon-chevron.png)Step 6 - Create Factory Class

> Factories are used in Object Oriented Programming as a way to instantiate an object.
>
> The Factory class name is the same as the Model class but with the word 'Factory' appended. Factories are injected as a dependency into other classes that you wish to use them within. During DI Compilation, it will automatically generate the Factory class in the var/generation folder if the class does not already exist. You will see the factory class in
>
> `var/generation/<vendor_name>/<module_name>/Model/ClassFactory.php`

![Magento Exam Information](./images/icon-info.png)There is no other setup required to create Factories, Magento will generate them on `setup:di:compile`

![Magento Exam Information](./images/icon-info.png)Factories are used when you want to create a new instance of a Model e.g. a new Product `Magento\Catalog\Model\Product` will be instantiated by the factory class `Magento\Catalog\Api\Data\ProductInterfaceFactory` .

![Magento Exam Information](./images/icon-info.png)Think of a literal factory production line which just keeps churning out new products of the same design. Use factories to instantiate a new edition of the class.

![Magento Exam Question](./images/icon-question.png)**How do you add a new table to the database?**

![Magento Section Chevron](./images/icon-chevron.png)Pre-Magento 2.3  - Install Scripts

Before Magento 2.3, extension developers were required to write code (PHP scripts) to change the database data / schema. The following types of scripts existed:

*   [InstallSchema](https://devdocs.magento.com/videos/fundamentals/add-a-new-table-to-database/%23step-2-create-an-installschema-script&sa=D&ust=1609223264808000&usg=AOvVaw1tQ8oggkW-gSRmeG9F0RAe) / [InstallData](https://devdocs.magento.com/videos/fundamentals/add-a-new-table-to-database/%23step-3-create-an-installdata-script&sa=D&ust=1609223264809000&usg=AOvVaw0-iTq7k-aZDXDydN6iEOZn) scripts, which are executed the first time a module is installed.
*   [UpgradeSchema](https://devdocs.magento.com/videos/fundamentals/add-a-new-table-to-database/%23step-5--create-an-upgradeschema-script&sa=D&ust=1609223264809000&usg=AOvVaw2fK09ff9UnGv__-ytpfT5W) / [UpgradeData](https://devdocs.magento.com/videos/fundamentals/add-a-new-table-to-database/%23step-6-create-the-upgradedata-script&sa=D&ust=1609223264810000&usg=AOvVaw0j9Fk1N0YdBcBqeKQbXzQj) incremental scripts, which supplement an existing module schema.
*   [Recurring schema](https://devdocs.magento.com/guides/v2.3/extension-dev-guide/prepare/lifecycle.html%23recurring-schema-event&sa=D&ust=1609223264810000&usg=AOvVaw3XrG9_7RqUQQBBriD9p7BF) event scripts, which are executed each time you install or upgrade Magento.

![Magento Exam Information](./images/icon-info.png)The main disadvantage of this approach is that Magento applies changes blindly. For example, in one version a new database column might be introduced, only to be removed in the next. Declarative setup eliminates this type of unnecessary work.

![Magento Section Chevron](./images/icon-chevron.png)Post-Magento 2.3 - Declarative setup

> Declarative setup is based on database structure declarations. Schema files declare what the database structure should be, and Magento determines the differences between the current table structure and what it should be. These differences can be represented with atomic SQL operations.
>
> Declarative Schema is defined in [<module_dir>/etc/db_schema.xml](https://devdocs.magento.com/guides/v2.3/extension-dev-guide/declarative-schema/db-schema.html&sa=D&ust=1609223264811000&usg=AOvVaw2NGT8LwDUsD4QgWZcMQjCs)

![Magento Exam Question](./images/icon-question.png)**Describe the entity load and save process.**

![Magento Section Chevron](./images/icon-chevron.png)Service Contracts & Repositories

> The Resource Model is responsible for CRUD and Validation operations for the entity database operations including loading and saving. Magento 2's modular flexibility, however, comes at a price. Business logic tends to leak across the layers of the Magento system, which manifests as duplicated and inconsistent code. To address these issues, the Magento system introduces [Service Contracts](https://devdocs.magento.com/guides/v2.3/extension-dev-guide/service-contracts/service-contracts.html&sa=D&ust=1609223264812000&usg=AOvVaw39YIqPi26jMy3hgXfyTNw4), which hide business logic details from service requesters such as controllers, web services, and other modules under [Data Interfaces](https://devdocs.magento.com/guides/v2.3/extension-dev-guide/service-contracts/design-patterns.html%23data-interfaces&sa=D&ust=1609223264813000&usg=AOvVaw2_qDAZ5piTdHK8ci_5x_pU) AKA Repositories.

![](./images/Magento-2-Certified-Professional-Developer-Guide-Request-Flow-Processing.jpg)

![Magento Section Chevron](./images/icon-chevron.png)Using the Repository pattern in custom code

> Repositories are designed so that we shouldn't need to inject anything else for CRUD operations in our custom modules. Products for example give you the Interface: \Magento\Catalog\Api\ProductRepositoryInterface to create products programmatically. You can tell which classes are specifically made available for custom code as they will be marked with the @api tag.

As per item [8.5 of the Technical Guidelines](https://devdocs.magento.com/guides/v2.3/coding-standards/technical-guidelines.html%238-modularity&sa=D&ust=1609223264814000&usg=AOvVaw31O8OYDMRSW5GnN2CFBk7h) given by Magento:

> "Only the @api code of any module can be referenced by other modules".
>
> We should strive to only use @api code in our custom code.

![Magento Exam Question](./images/icon-question.png)**Describe how to extend existing entities.**

> Schema is used to create/update DB tables and its structure. While Data is used to insert/add data into tables

### ![Magento Section Chevron](./images/icon-chevron.png)Custom (EAV) Attributes

> Custom Attributes are defined as a subset of Entity-Attribute-Values (EAV). EAV attributes typically store values in several MySQL tables. For Products, a merchant can add new attributes via the admin or programmatically. For Orders & Customers this requires extending Magento programmatically.
>
> The Catalog module has several attributes that are defined as EAV attributes, but are treated as built-in attributes. These attributes include:

*   `name`
*   `price`
*   `sku`
*   etc...
*   See the [Simple Product section below](#h.cbgifdse6zd5) for more information on how the other default attributes.

> To check if an entity supports Extension Attributes, check the Api/ interface of the entity in mind for methods:

*   `getCustomAttributes()`
*   `setCustomAttributes()`

> This will determine if they are available for that entity.
>
> You can also check if your entity extends interface `Magento\Framework\Api\CustomAttributesDataInterface` - to decipher if they are compatible with Custom (EAV) Attributes. `Magento\Framework\Api\CustomAttributesDataInterface` defines the methods that are called to get and set Custom (EAV) Attributes.
>
> Custom (EAV) Attributes are created using:

*   [Data Patches](https://devdocs.magento.com/guides/v2.3/extension-dev-guide/declarative-schema/data-patches.html&sa=D&ust=1609223264818000&usg=AOvVaw30oojC9eaLdkq5AtiOLmpA). Using a Setup Factory e.g. Magento\Customer\Setup\CustomerSetupFactory
*   Creating a [Service Contract](#h.i0qq8aqgijv7) which implements interface `Magento\Framework\Api\CustomAttributesDataInterface`.
*   Declarative Schema: <module_dir>/etc/eav_attributes.xml

`eav_attributes.xml` provides the EAV attributes configuration.

For example, in `vendor/magento/module-catalog/etc/eav_attributes.xml` you can see many attributes like sku, status, etc and the configuration says about those attributes like if the attribute is global or it is searchable or filterable. Similar things that we do while creating a custom attribute using the Data Patch.

![Magento Exam Information](./images/icon-info.png)Think EAV, think `catalog_product_entity` ➞ `eav_attribute` table ➞ (`catalog_product_entity_varchar`, `catalog_product_decimal`) etc

#### eav_attributes.xml

```xml
<?xml version="1.0"?>

<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:module:Magento_Eav:etc/eav_attributes.xsd">

    <entity type="catalog_product">
        <attribute code="sku">
            <field code="is_global" locked="true" />
            <field code="is_unique" locked="true" />
        </attribute>
        <attribute code="status">
            <field code="is_searchable" locked="true" />
            <field code="is_filterable" locked="true" />
            <field code="is_filterable_in_search" locked="true" />
        </attribute>
        <attribute code="visibility">
            <field code="is_searchable" locked="true" />
            <field code="is_filterable" locked="true" />
            <field code="is_filterable_in_search" locked="true" />
        </attribute>
        <attribute code="country_of_manufacture">
            <field code="is_searchable" locked="true" />
            <field code="is_filterable" locked="true" />
            <field code="is_filterable_in_search" locked="true" />
        </attribute>
        <attribute code="price_type">
            <field code="is_searchable" locked="true" />
        </attribute>
        <attribute code="name">
            <field code="is_html_allowed_on_front" locked="true"/>
        </attribute>
        <attribute code="category_ids">
            <field code="is_global" locked="true" />
            <field code="is_searchable" locked="true" />
            <field code="used_for_sort_by" locked="true" />
            <field code="is_used_in_grid" locked="true" />
            <field code="is_visible_in_grid" locked="true" />
            <field code="is_filterable_in_grid" locked="true" />
        </attribute>
        <attribute code="media_gallery">
            <field code="is_searchable" locked="true" />
        </attribute>
        <attribute code="tier_price">
            <field code="used_for_sort_by" locked="true" />
        </attribute>
    </entity>
</config>
```

Getter/Setter
```php
Magento\Customer\Api\Data\AddressInterface::getCustomAttribute(
    $attributeCode
); // Get the Custom (EAV) Attribute

Magento\Customer\Api\Data\AddressInterface::setCustomAttribute(
    $attributeCode,
    $attributeValue
); // Set the Custom (EAV) Attribute

Magento\Customer\Api\AddressRepositoryInterface::save(
    Magento\Customer\Api\Data\AddressInterface $address
);  // Save the entity
 ```

### ![Magento Section Chevron](./images/icon-chevron.png)Extension Attributes

> When adding new attributes to entities, We can't change the interface each time we want to add a new attribute as we would lose backwards compatibility. Our logic has to be in line with the [Service Contracts](#h.i0qq8aqgijv7) design pattern (mentioned earlier). Third-party developers cannot change the API Data interfaces defined in the Magento Core code. However, most of these entities have a feature called Extension Attributes.
>
> To check if an entity supports Extension Attributes, check the Api/ interface of the entity in mind for methods:

*   `getExtensionAttributes()`
*   `setExtensionAttributes()`

> This will determine if they are available for that entity.
>
> You can also check if your entity extends interface `Magento\Framework\Api\ExtensibleDataInterface` - to decipher if they are compatible with Extension Attributes
>
> Extension Attributes are new in Magento 2. They are used to extend functionality and often use more complex data types than [Custom Attributes](#h.k3zjo176fdlt) (above).
>
> Features
>
> Extension Attributes do not appear in the Magento Admin.
>
> Extension Attributes are created using:

*   [Data Patches](https://devdocs.magento.com/guides/v2.3/extension-dev-guide/declarative-schema/data-patches.html&sa=D&ust=1609223264830000&usg=AOvVaw13nYcuIOQjAQiYrtmRsgiJ). Using a Setup Factory e.g. Magento\Customer\Setup\CustomerSetupFactory
*   Creating a [Service Contract](#h.i0qq8aqgijv7) which implements interface Magento\Framework\Api\ExtensibleDataInterface.
*   Declarative Schema: `<module_dir>/etc/extension_attributes.xml`

> Extension Attributes have the advantage of declarative schema and are defined in `<module_dir>/etc/extension_attributes.xml`
>
> Extension Attributes are used to extend functionality and often use more complex data types than custom or eav attributes. These attributes do not appear in the Magento Admin.
>
> extension_attributes.xml is used for declaring the extension attributes for the module.

#### extension_attributes.xml

```xml
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:Api/etc/extension_attributes.xsd">
    <extension_attributes for="Magento\Sales\Api\Data\OrderInterface">
        <attribute code="name_of_attribute" type="<DATA_TYPE>">
            <resources>
                <resource ref="<PERMISSION>"/>
            </resources>
            <join reference_table="" reference_field="" join_on_field="">
                <field>fieldname</field>
            </join>
        </attribute>
    </extension_attributes>
</config>
```

| Properties | Field | Description | Example |
| --- | --- | --- | --- |
| `<extension_attributes>` | Attributes: `for` - The fully-qualified type name with the namespace that processes the extensions. The value must be a type that implements `ExtensibleDataInterface`. The interface can be in a different module. Elements: Field: `<attribute>` | `Magento\Quote\Api\Data\TotalsInterface` |
| `<attribute>` | Attributes: `code` - The name of the attribute. The attribute name should be in snake case (the first letter in each word should be in lowercase, with each word separated by an underscore). `type` - The data type. This can be a simple data type, such as string or integer, or complex type, such as an interface. Elements - Field: `<resources>`, Field: `<join>` | `code` : `gift_cards_amount_used`, `type` - `float`, `Magento\CatalogInventory\Api\Data\StockItemInterface` |
| `<resources>` | Elements: Field: `<resource>` | |
| `<resource>` | Attributes: `ref` - Optional. Restricts access to the extension attribute to users with the specified permission. Elements: Field - `<resource>` | `Magento_CatalogInventory::cataloginventory` |
| `<join>` | Attributes: `reference_table` - The table involved in a join operation. [See Searching Extension Attributes](https://devdocs.magento.com/guides/v2.3/extension-dev-guide/attributes.html%23search&sa=D&ust=1609223264844000&usg=AOvVaw1LwiBr2j-FftDHXe8-7zbF) for details. `reference_field`: Column in the reference_table. `join_on_field`: The column of the table associated with the interface specified in the for keyword that will be used in the join operation. Elements: Field - `<field>` | `reference_table`: `admin_user`, `reference_field`: `user_id`, `join_on_field`: `store_id`. [Here is a good article](https://fishchenko.com/blog/magento-2-join-table-in-orderrepositorygetlist-extension-attributes/&sa=D&ust=1609223264847000&usg=AOvVaw1axgrEfJhYCZBW4s8b9AlM) on how to access the Join Processor from the extended class. |
| `<field>` | One or more fields present in the interface specified in the type keyword. You can specify the `column=""` keyword to define the column in the `reference_table` to use. The field value specifies the property on the interface which should be set. | `<field column="customer_group_code">code</field>` |


> In your concrete class implementation of the above data interface will look something like:
```php
namespace <MY>\<MODULE>\Model\Data;

class ExampleAttribute implements <MY>\<MODULE>\Api\Data\<ExampleAttributeInterface
{
    /**
     * {@inheritdoc}
     */
    public function getValue()
    {
        return $this->getData(self::VALUE);
    }

    /**
     * {@inheritdoc}
     */
    public function setValue($value)
    {
        return $this->setData(self::VALUE, $value);
    }
}
```
![Magento Exam Information](./images/icon-info.png)[Extension Attributes](#h.aqe3c923mrz4) are not magically saved to the database or populated when the quote or order, etc is loaded from the database.

![Magento Exam Information](./images/icon-info.png) `type="<DATA_TYPE>"` Can be scalar / non-scalar, meaning either: string or `<MY>\<MODULE>\Api\Data\<ExampleAttributeInterface>` or `string[]`

![Magento Exam Information](./images/icon-info.png)This means that we are extending our Sales Order Interface with an attribute. It's accessible via `$order->getExtensionAttributes()->getNameOfAttribute()`.

![Magento Exam Information](./images/icon-info.png)[Here is a good article](https://fishchenko.com/blog/magento-2-join-table-in-orderrepositorygetlist-extension-attributes/&sa=D&ust=1609223264850000&usg=AOvVaw3BeT6r7k6d3f8Db4JZBUHE) on how to access the Join Processor from the extended class

![Magento Exam Information](./images/icon-info.png)[Here's a great guide](https://store.fooman.co.nz/blog/an-introduction-to-extension-attributes.html&sa=D&ust=1609223264851000&usg=AOvVaw3fKCSQfPQRXzfs69ukWnJy) on what Extension Attributes.

![Magento Exam Information](./images/icon-info.png)Extension Attributes Advantages = declarative schema, can involve more complex data types, they are in-line with Service Contract design pattern, are better for backward compatibility rather than changing core interfaces.

Saving and retrieving

Saving [Extension Attributes](#h.aqe3c923mrz4) will require a custom persistence layer for storage. Therefore, the rest of the [Service Contracts](#h.i0qq8aqgijv7) will need to be created i.e. a custom:

*   [Repository](#h.5y2r6c8djm3h)
*   [Resource Model](#h.h64lcrmfa6jp)
*   [Collection](#h.ovkq1s5o8zg)
*   [Search Criteria](#h.5y2r6c8djm3h)
*   [Declarative Schema](#h.iqvl9uln4170)

will be required.

[Extension Attributes](#h.aqe3c923mrz4) are not magically saved to the database or populated when the quote or order, etc is loaded from the database. Therefore you will need to set them using a [Plugin Interceptor](#h.nc1ow1wmf2km) or an [Observer](#h.y2lezqicnwxl). Here is an example of a Plugin:
`etc/di.xml`
```xml
<?xml version="1.0"?>

<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">
    <type name="Magento\Sales\Api\OrderRepositoryInterface">
        <plugin name="save_example_attribute" type="MyVendor\MyModule\Plugin\OrderSave"/>
        <plugin name="get_example_attribute" type="MyVendor\MyModule\Plugin\OrderGet"/>
    </type>
</config>
```
```php
<?php

namespace MyVendor\MyModule\Plugin;

use Magento\Framework\Exception\CouldNotSaveException;

class OrderSave
{
    public function afterSave(
        \Magento\Sales\Api\OrderRepositoryInterface $subject,
        \Magento\Sales\Api\Data\OrderInterface $resultOrder

    ) {
        $resultOrder = $this->saveExampleAttribute($resultOrder);
        return $resultOrder;
    }

    private function saveExampleAttribute(\Magento\Sales\Api\Data\OrderInterface $order)
    {
        $extensionAttributes = $order->getExtensionAttributes();
        if (
            null !== $extensionAttributes &&
            null !== $extensionAttributes->getExampleAttribute()
        ) {

            $exampleAttributeValue = $extensionAttributes->getExampleAttribute()->getValue();

            try {

                // The actual implementation of the repository is omitted
                // but it is where you would save to the database (or any other persistent storage)
                $this->exampleExampleRepository->save($order->getEntityId(), $exampleAttributeValue);
            } catch (\Exception $e) {

                throw new CouldNotSaveException(
                    __('Could not add attribute to order: "%1"', $e->getMessage()),
                    $e
                );
            }
        }

        return $order;
    }
}

```
![Magento Exam Question](./images/icon-question.png)**What is the difference between Custom Attributes and Extension Attributes**

> [Custom Attributes](#h.k3zjo176fdlt) are the attributes added to describe an entity, such as product attributes, customer attributes etc. These are a subset of EAV attributes.
>
>
> [Extension Attributes](#h.aqe3c923mrz4) on the other hand are generally used for more complex data types such as adding additional complex data into an entity from a custom external table.
> Simply put, custom attributes conform to EAV standards whereas extension attributes are used for more complex data which custom attributes cannot handle.

![Magento Exam Question](./images/icon-question.png)**How do you select a subset of records from the database?**

> Use `addFieldToSelect` and `addAttributeToSelect` methods of a Collection to specify the fields for selection.
>
> For example:
>
>    `$productCollection->addFieldToSelect("custom_field");`
>
> To apply filters to collections, use
>
>    `addAttributeToFilter($field, $condition)`
>
>    `addFieldToFilter($field, $condition)`

Conditions can be one of the following:

### Where Query Operators

| Magento Associative Array Condition | MySQL Condition |
| --- | --- |
| `"eq"` | Equals Value |
| `"neq"` | Not Equal Value |
| `"like"` | Like Value |
| `"nlike"` | Not Like Value |
| `"is"` | Is Value |
| `"in"` | In Values |
| `"nin"` | Not In Values |
| `"notnull"` | Value Is Not Null |
| `"null"` | Value Is Null, example: `$c->prepareSqlCondition('finished_at', ['null' => NULL])` |
| `"moreq"` | More Or Equal Value
| `"gt"` | Greater Value |
| `"lt"` | Less Value |
| `"gteq"` | Greater Or Equal Value |
| `"lteq"` | Less Or Equal Value |
| `"finset"` | Value In Set |
| `"from" => "value", "to" => "value"` | In Between "from" & "to" Values |


> Example:
>
> `$productCollection->addFieldToFilter('entity_id', array('in' => [1,2,3])`
>
> `setOrder` method is used for sorting and processes both filter and direction fields. For instance:
>
> `$productCollection>setOrder('position','ASC');`
>
> `searchCriteria` is used for applying filters in repositories. More on that above.

![Magento Exam Question](./images/icon-question.png)**Describe the Database Abstraction Layer for Magento.**

> The Database Abstraction Layer performs generic database operations like connections, commands, parameters insulating you from vendor specific data libraries and providing one high level api for accessing data regardless of whether you use MySQL, Microsoft SQL Server, Oracle, DB2, etc...

![Magento Exam Information](./images/icon-info.png)The Resource Model of each Entity acts as the Database Abstraction Layer.

![Magento Exam Information](./images/icon-info.png)This gives Magento 2 the ability to better plug-in and out different DB management systems such as Postgres SQL - Which they might start diving into in the near future.

![Magento Exam Question](./images/icon-question.png)**What type of exceptions does the database layer throw?**

> Database layer can put out exceptions depending on its realization. For example,
> PDO/Mysql can put out the following exceptions:

*   Zend_Db_Adapter_Exception
*   Zend_Db_Statement_Exception
*   Zend_Db_Exception
*   Zend_Db_Statement_Pdo
*   PDOException
*   LocalizedException
*   InvalidArgumentException
*   Exception
*   DuplicateException

![Magento Exam Information](./images/icon-info.png)Not certain how important this is to learn really.

![Magento Exam Question](./images/icon-question.png)**What additional functionality does Magento provide over Zend_Adapter?**

> The following additional methods are realized atop Zend_Adapter:

*   addUniqueField
*   unserializeFields
*   serializeFields
*   hasDataChanged
*   prepareDataForUpdate
*   isObjectNotNew
*   saveNewObject
*   afterSave
*   beforeSave
*   isModified
*   afterLoad
*   beforeDelete
*   afterDelete

![Magento Exam Information](./images/icon-info.png)Not certain how important this is to learn really.

4.2 Demonstrate an ability to use declarative schema
----------------------------------------------------

![Magento Exam Question](./images/icon-question.png)**Demonstrate use of schema.**

> Schema setup scripts change database schema, they create or change needed database tables.

![Magento Exam Information](./images/icon-info.png)i.e Create a new table and its fields with its structure.

![Magento Exam Question](./images/icon-question.png)**How to manipulate columns and keys using declarative schema?**

![Magento Section Chevron](./images/icon-chevron.png) `db_schema.xml`

> Magento prioritizes the declarative schema approach and executes updates from the [db_schema.xml](https://devdocs.magento.com/guides/v2.3/extension-dev-guide/declarative-schema/db-schema.html&sa=D&ust=1609223264887000&usg=AOvVaw3s2_fjZNEGX96-L5Vm0X92) before the data and schema patches.

![Magento Exam Information](./images/icon-info.png)All database related extension or manipulation all belong in the `<module_dir>/Setup` directory. A good example would be the [Magento_Catalog](https://github.com/magento/magento2/blob/2.3/app/code/Magento/Catalog/etc/db_schema.xml&sa=D&ust=1609223264888000&usg=AOvVaw3m3468kc66q7g7KAms8WeZ)

![Magento Exam Information](./images/icon-info.png)Schema is used to create/update DB tables and its structure. While Data is used to insert/add data into tables.

Example `db_schema.xml`:
```xml
<?xml version="1.0"?>
<schema xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:Setup/Declaration/Schema/etc/schema.xsd">
    <table name="my_table" resource="default" engine="innodb" comment="Example Table">
        <column xsi:type="int" name="entity_id" padding="10" unsigned="true" nullable="false" identity="true" comment="ID"/>
        <column xsi:type="varchar" name="name" comment="Name"/>
        <column xsi:type="varchar" name="body" comment="Body"/>
        <constraint xsi:type="primary" referenceId="PRIMARY">
            <column name="entity_id"/>
        </constraint>
        <index referenceId="Vendor_MyModule_TABLE1_ID" indexType="btree">
            <column name="entity_id"/>
        </index>
    </table>
</schema>
```
| Field | Description |
| --- | --- |
| `<table>` | Attributes: `name` - Name of the table. `comment` - Comment for the table. `engine` - SQL engine. This value must be innodb or memory. `resource` - The database shard on which to install the table. This value must be "default", "checkout", or "sales". Elements `<column>` |
| `<column>` | Attributes: `xsi:type` - Column types include: blob (includes blob, mediumblob, longblob), boolean, date, datetime, decimal, float, int (includes smallint, bigint, tinyint), real (includes decimal, float, double, real), smallint, text (includes text, mediumtext, longtext), timestamp, varbinary, varchar. `name` - Column name. `padding` - The size of an integer column. `usigned` - For numeric data types, specifies whether the column can contain positive and negative values or only positive values. `nullable` - Indicates whether the column can be nullable. `identity` - Indicates whether a column is auto-incremented. `comment` - Comment for the column. |
| `<constraint>` | Attributes: `type` - One of "primary", "unique", or "foreign". `referenceId` - A custom identifier that is used only for relation mapping in the scope of `db_schema.xml` files. The real entity in the database has a system-generated name. The most convenient way to set the value of this attribute is to use the value that is written in the module's `db_schema_whitelist.json` file when you run the generate-whitelist command. **NOTE:** ensure your foreign key constraint matches the same type as the referencing column, otherwise you risk the misleading "MySQL: Foreign key constraint is incorrectly formed" error. |
| `<index>` | Attributes: `indexType` - The value must be "btree", "fulltext", or "hash". `referenceId` - A custom identifier that is used only for relation mapping in the scope of db_schema.xml files. The real entity in the database has a system-generated name. The most convenient way to set the value of this attribute is to use the value that is written in the module's `db_schema_whitelist.json` file when you run the generate-whitelist command. |

![Magento Exam Question](./images/icon-question.png)**What is the purpose of whitelisting?**

> The db_schema_whitelist.json file is a way of telling Magento which tables and columns it can safely alter using the db_schema.xml It was added to preserve backward compatibility. Since Backward compatibility must be maintained, declarative schema does not automatically delete database tables, columns or keys that are not defined in a db_schema.xml as they can be declared somewhere else such as Setup/UpgradeSchema.php
>
> The Magento 2.3+ version of the command to generate a <module_dir>/etc/db_schema_whitelist.json file:
>
> `php bin/magento declaration:generate:whitelist`

![Magento Exam Note Warning](images/icon-warning.png)`db_schema_whitelist.json` is a temporary solution. It will be removed in the future, when upgrade scripts are no longer supported.

![Magento Exam Note Warning](images/icon-warning.png)Whitelists cannot be generated on Magento instances that use a database prefix.

Example of a `db_schema_whitelist.json` file:
```json
{
    "my_table_1": {
        "column": {
            "column_1": true,
            "column_2": true,
            "column_3": true
        },
        "index": {
            "MY_TABLE_1_COLUMN_1": true
        },
        "constraint": {
            "PRIMARY": true
        }
    },
    "my_table_2": {
        ……
    }
}
```
![Magento Exam Question](./images/icon-question.png)**How to use Data and Schema patches?**

### ![Magento Section Chevron](./images/icon-chevron.png) Data Patches

> A Data Patch is a Setup class that contains data modification instructions.
>
> Data Patches and belong in a `<module_dir>/Setup/Patch/Data/<patch_name>.php` directory of a custom [Module](#h.8r6t4fakpxnh).

```php
<?php

namespace Magento\DummyModule\Setup\Patch\Data;

use Magento\Framework\Setup\Patch\DataPatchInterface;
use Magento\Framework\Setup\ModuleDataSetupInterface;
use Magento\Framework\Setup\Patch\PatchRevertableInterface;

class DummyDataPatch implements DataPatchInterface, PatchRevertableInterface
{
    /**
     * @var ModuleDataSetupInterface
     */
    private $moduleDataSetup;

    /**
     * @param ModuleDataSetupInterface $moduleDataSetup
     */
    public function __construct(ModuleDataSetupInterface $moduleDataSetup)
    {
        $this->moduleDataSetup = $moduleDataSetup;
    }

    /**
     * {@inheritdoc}
     */
    public function apply()
    {
        $this->moduleDataSetup->getConnection()->startSetup();
        // The code that you want apply in the patch
        $this->moduleDataSetup->getConnection()->endSetup();
    }

    /**
     * {@inheritdoc}
     */

    public static function getDependencies()
    {
        return [
            SomeDependency::class
        ];
    }

    public function revert()
    {
        $this->moduleDataSetup->getConnection()->startSetup();
        // Revert operations here
        $this->moduleDataSetup->getConnection()->endSetup();
    }

    /**
     * {@inheritdoc}
     */
    public function getAliases()
    {
        return [];
    }
}

```
> `apply()` - The code that you want to apply in the patch goes here. Please note, that one patch is responsible only for one setup version. So one UpgradeData can consist of a few data patches.getAliases() - This internal Magento method, that means that some patches with time can change their names, but changing name should not affect installation process, that's why if we will change name of the patch we will add alias here
>
> `revert()` - Mentioned below
>
> `getDependencies()` - Mentioned below

![Magento Exam Information](./images/icon-info.png)Data setup is executed after Schema setup, they function in a similar fashion.

![Magento Exam Information](./images/icon-info.png)A list of applied patches is stored in the `patch_list` database table.

![Magento Exam Information](./images/icon-info.png)Just remember that Patches contain data modification instructions. They implement `DataPatchInterface` & `PatchRevertableInterface` and are located in `<module_dir>/Setup/Patch/Data/<patch_name>.php`

![Magento Section Chevron](./images/icon-chevron.png) Reverting Data Patches

> Magento does not allow you to revert a particular module data patch. However, you can revert all installed data patches of a single module.Run the following command to revert all composer installed data patches:
>
> `bin/magento module:uninstall Vendor_ModuleName`
>
> Run the following command to revert all non-composer installed data patches:
>
> `bin/magento module:uninstall --non-composer Vendor_ModuleName`
>
> This will run the public function `revert()` method of your modules `Magento\Framework\Setup\Patch\PatchRevertableInterface` implementation.
>
> `revert()` - Here should go code that will revert all operations from apply() method. Please note that some operations, like removing data from columns, that is in the role of foreign key reference is dangerous, because it can trigger an `ON DELETE` statement.

### ![Magento Section Chevron](./images/icon-chevron.png) Schema Patches

> A Schema Patch is a Setup class that contains custom schema (database) modification instructions.
>
> These modifications can be complex. It is defined in a `<module_dir>/Setup/Patch/Schema/<patch>.php` file and implements `Magento\Framework\Setup\Patch\SchemaPatchInterface`.

![Magento Exam Information](./images/icon-info.png)Unlike the declarative schema approach, patches will only be applied once. A list of applied patches is stored in the patch_list database table. An unapplied patch will be applied when running the setup:upgrade from the Magento CLI.

> Schema Patches and belong in a `<module_dir>/Setup/Patch/Schema/<patch_name>.php` directory of a custom Module.

```php
<?php

namespace Magento\DummyModule\Setup\Patch\Schema;

use Magento\Framework\Setup\Patch\SchemaPatchInterface;
use Magento\Framework\Setup\ModuleDataSetupInterface;
use Magento\Framework\Setup\Patch\PatchRevertableInterface;

class DummySchemaPatch implements SchemaPatchInterface, PatchRevertableInterface
{
    /**
     * @var ModuleDataSetupInterface
     */
    private $moduleDataSetup;

    /**
     * @param ModuleDataSetupInterface $moduleDataSetup
     */
    public function __construct(ModuleDataSetupInterface $moduleDataSetup)
    {
        $this->moduleDataSetup = $moduleDataSetup;
    }

    /**
     * {@inheritdoc}
     */
    public function apply()
    {
        $this->moduleDataSetup->getConnection()->startSetup();
        // The code that you want apply in the patch
        $this->moduleDataSetup->getConnection()->endSetup();
    }

    /**
     * {@inheritdoc}
     */
    public static function getDependencies()
    {
        return [
            SomeDependency::class
        ];
    }

    public function revert()
    {
        $this->moduleDataSetup->getConnection()->startSetup();
        // Revert operations here
        $this->moduleDataSetup->getConnection()->endSetup();
    }

    /**
     * {@inheritdoc}
     */
    public function getAliases()
    {
        return [];
    }
}

```

> `apply()` - Mentioned above
>
> `getAliases()` - Mentioned above
>
> `revert()` - Mentioned above
>
> `getDependencies()` - Mentioned below

![Magento Exam Question](./images/icon-question.png)**How to manage dependencies between patch files?**

> `getDependencies()` - defines dependencies to another patch. Each dependency should be applied first. One patch can have few dependencies. Patches do not have versions, so if in the old approach with Install/Upgrade data scripts you used versions, right now you need to point from patch with higher version to patch with lower version But please, note, that some of your patches can be independent and can be installed in any sequence. So use dependencies only if this is important for you.